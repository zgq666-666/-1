<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©å¤§æˆ˜åƒµå°¸ - æœ€ç»ˆå®Œæ•´ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pvz: {
                            grass: '#78AB46',
                            soil: '#8B4513',
                            sun: '#FFD700',
                            plant: '#2E8B57',
                            zombie: '#4B0082',
                            game: '#1E3A8A',
                            progress: '#ff4757'
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .grid-cols-9 { grid-template-columns: repeat(9, 1fr); }
            .grid-rows-5 { grid-template-rows: repeat(5, 1fr); }
            .animate-sun { animation: sunFloat 8s infinite ease-in-out; }
            .animate-attack { animation: attack 0.5s ease infinite; }
            .hurt { animation: hurt 0.2s ease; }
            .animate-explode { animation: explode 0.5s ease-out; }
        }

        @keyframes sunFloat {
            0%,100% { transform: translate(0,0); }
            50% { transform: translate(5px,-5px); }
        }
        
        @keyframes attack {
            0%,100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes hurt {
            0%,100% { filter: brightness(1); }
            50% { filter: brightness(0.5); }
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(3); opacity: 0.8; }
            100% { transform: scale(5); opacity: 0; }
        }
        
        /* ç”¨æˆ·åå¼¹çª—æ ·å¼ */
        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .username-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        
        .username-form input {
            padding: 10px;
            font-size: 16px;
            width: 80%;
            margin: 10px 0;
            border: 2px solid #ccc;
            border-radius: 5px;
        }
        
        .username-form button {
            padding: 10px 20px;
            background-color: #2E8B57;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .username-form button:hover {
            background-color: #1f6e43;
        }
        
        /* æ¸¸æˆæ ¸å¿ƒæ ·å¼ */
        #game-container {
            width: 900px;
            height: 500px;
            margin: 0 auto;
            position: relative;
            border: 2px solid #5a8c3a;
        }
        
        #game-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(9, 100px);
            grid-template-rows: repeat(5, 100px);
            gap: 1px;
        }
        
        .game-cell {
            background-color: #78AB46;
            border: 1px solid #5a8c3a;
            position: relative;
            cursor: pointer;
            z-index: 5;
        }
        
        .plant {
            position: absolute;
            z-index: 8;
            width: 80px;
            height: 80px;
            top: 10px;
            left: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: attack 0.5s ease infinite;
        }
        
        /* ä¸åŒåƒµå°¸æ ·å¼ */
        .zombie {
            position: absolute;
            z-index: 10;
            width: 80px;
            height: 80px;
            top: 10px;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: left 0.1s linear;
        }
        
        .zombie-normal {
            background-color: #4B0082;
        }
        
        .zombie-trash {
            background-color: #333333;
            border: 3px solid #666666;
        }
        
        .zombie-iron {
            background-color: #222222;
            border: 4px solid #888888;
        }
        
        /* åƒµå°¸å¤´éƒ¨è£…é¥° */
        .zombie-trash::before {
            content: "ğŸ—‘ï¸";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
        }
        
        .zombie-iron::before {
            content: "ğŸª£";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
        }
        
        .bullet {
            position: absolute;
            z-index: 9;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ff0000;
        }
        
        /* æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸æ•ˆæœ */
        .explosion {
            position: absolute;
            z-index: 50;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ff4500;
            box-shadow: 0 0 30px #ff0000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            animation: explode 0.5s ease-out forwards;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 900px;
            height: 20px;
            background-color: #333;
            margin: 0 auto 10px;
            position: relative;
            border-radius: 10px;
        }
        
        .progress-fill {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: #ff4757;
            transition: transform 0.1s linear;
            transform: translateX(0);
        }
        
        .progress-end {
            position: absolute;
            top: 0;
            left: 0;
            width: 30px;
            height: 100%;
            background-color: #ff3838;
            z-index: 2;
            border-radius: 10px 0 0 10px;
        }
        
        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            color: white;
            text-align: center;
            line-height: 20px;
            z-index: 3;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* é˜³å…‰æ ·å¼ */
        .sun-item {
            position: absolute;
            z-index: 15;
            cursor: pointer;
            font-size: 28px;
            color: #FFD700;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        
        /* å±‚çº§ç®¡ç† */
        #sun-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 12;
            pointer-events: none;
        }
        
        #zombie-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 11;
            pointer-events: none;
        }
        
        #bullet-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        #explosion-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 40;
            pointer-events: none;
        }
        
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 24px;
            z-index: 20;
            display: none;
        }
        
        /* ç©å®¶ä¿¡æ¯æ˜¾ç¤º */
        .player-info {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* åƒµå°¸ç»Ÿè®¡æ˜¾ç¤º */
        .zombie-stats {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4">
    <div class="max-w-6xl mx-auto">
        <!-- ç”¨æˆ·åå¼¹çª— -->
        <div id="username-modal" class="username-modal">
            <div class="username-form">
                <h2>ğŸŒ± æ¤ç‰©å¤§æˆ˜åƒµå°¸ ğŸŒ±</h2>
                <p>è¯·è¾“å…¥ä½ çš„ç”¨æˆ·å</p>
                <input type="text" id="username-input" placeholder="è¾“å…¥æ˜µç§°..." maxlength="10" required>
                <br>
                <button id="confirm-username">å¼€å§‹æ¸¸æˆ</button>
                <p class="text-red-500 text-sm mt-2" id="username-error" style="display: none;">è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·åï¼</p>
            </div>
        </div>

        <!-- ç©å®¶ä¿¡æ¯ -->
        <div class="player-info" id="player-info" style="display: none;">
            ç©å®¶: <span id="player-name"></span> | å‡»æ€æ•°: <span id="kill-count">0</span>/<span id="kill-total">20</span>
        </div>
        
        <!-- åƒµå°¸ç±»å‹è¯´æ˜ -->
        <div class="zombie-stats" id="zombie-stats" style="display: none;">
            ğŸ§Ÿæ™®é€šåƒµå°¸(15è¡€) | ğŸ—‘ï¸åƒåœ¾æ¡¶åƒµå°¸(22.5è¡€) | ğŸª£é“æ¡¶åƒµå°¸(30è¡€) | ğŸ’æ¨±æ¡ƒç‚¸å¼¹(150é˜³å…‰)ï¼šèŒƒå›´9æ ¼+é‚»è¿‘2è¡Œç§’æ€
        </div>

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-green-700">æ¤ç‰©å¤§æˆ˜åƒµå°¸ - æœ€ç»ˆå®Œæ•´ç‰ˆ</h1>
            <div class="flex gap-4 items-center">
                <div class="flex items-center gap-2">
                    <i class="fa fa-sun-o text-yellow-500 text-2xl"></i>
                    <span id="sun-count" class="text-xl font-bold">50</span>
                </div>
                <button id="start-game" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition" disabled>å¼€å§‹æ¸¸æˆ</button>
                <button id="reset-game" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition" disabled>é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>

        <!-- æ¤ç‰©é€‰æ‹©åŒº -->
        <div class="flex gap-4 mb-4 flex-wrap">
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-green-600 text-white transition" data-plant="peashooter" data-cost="100">
                <i class="fa fa-circle text-xl"></i>
                <div class="mt-1">è±Œè±†å°„æ‰‹ (100é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-yellow-600 text-white transition" data-plant="sunflower" data-cost="50">
                <i class="fa fa-sun-o text-xl"></i>
                <div class="mt-1">å‘æ—¥è‘µ (50é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-yellow-800 text-white transition" data-plant="wallnut" data-cost="50">
                <i class="fa fa-square text-xl"></i>
                <div class="mt-1">åšæœå¢™ (50é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-blue-600 text-white transition" data-plant="snowpea" data-cost="175">
                <i class="fa fa-snowflake-o text-xl"></i>
                <div class="mt-1">å¯’å†°å°„æ‰‹ (175é˜³å…‰)</div>
            </div>
            <div class="plant-card cursor-pointer p-3 border-2 border-transparent hover:border-yellow-500 rounded bg-red-700 text-white transition" data-plant="cherrybomb" data-cost="150">
                <i class="fa fa-bomb text-xl"></i>
                <div class="mt-1">æ¨±æ¡ƒç‚¸å¼¹ (150é˜³å…‰)</div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar mb-2">
            <div id="progress-fill" class="progress-fill"></div>
            <div class="progress-end"></div>
            <div class="progress-text">åƒµå°¸è¿›æ”»è¿›åº¦ï¼ˆåˆ°è¾¾å·¦ä¾§çº¢è‰²ç»ˆç‚¹å¤±è´¥ï¼‰</div>
        </div>

        <!-- æ ¸å¿ƒæ¸¸æˆåŒº -->
        <div id="game-container">
            <div id="game-grid" class="grid-cols-9 grid-rows-5"></div>
            <div id="sun-layer"></div>
            <div id="zombie-layer"></div>
            <div id="bullet-layer"></div>
            <div id="explosion-layer"></div>
            <div id="game-over">æ¸¸æˆå¼€å§‹ï¼</div>
        </div>
        
        <!-- æ“ä½œæç¤º -->
        <div class="mt-4 text-center text-gray-600">
            <p>æ“ä½œè¯´æ˜ï¼š1.é€‰æ‹©æ¤ç‰©å¡ç‰‡ â†’ 2.ç‚¹å‡»è‰åªæ”¾ç½®æ¤ç‰© â†’ 3.ç‚¹å‡»é˜³å…‰æ”¶é›†èµ„æº â†’ 4.æ¶ˆç­20ä¸ªåƒµå°¸é€šå…³</p>
            <p class="text-red-600">æ–°å¢å†…å®¹ï¼šæ™®é€š/åƒåœ¾æ¡¶/é“æ¡¶åƒµå°¸ | æ¨±æ¡ƒç‚¸å¼¹èŒƒå›´ç§’æ€ | åƒµå°¸5ç§’ååˆ·æ–° | å‘æ—¥è‘µ1ç§’â†’1.5ç§’äº§é˜³å…‰</p>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒçŠ¶æ€
        const game = {
            isRunning: false,
            username: '',
            sun: 50,
            selectedPlant: null,
            cellSize: 100,
            grid: [],
            plants: [],
            zombies: [],
            suns: [],
            progress: 0,
            // è°ƒæ•´åçš„æ¸¸æˆå‚æ•°
            gameBalance: {
                zombieSpawnDelay: 5000,     // åƒµå°¸å»¶è¿Ÿ5ç§’å¼€å§‹åˆ·æ–°
                zombieSpawnRate: 4500,      // åƒµå°¸åˆ·æ–°é—´éš”ï¼ˆå»¶è¿Ÿåï¼‰
                plantAttackRate: 1200,      // æ¤ç‰©æ”»å‡»é—´éš”
                zombieSpeed: 0.8,           // åƒµå°¸ç§»åŠ¨é€Ÿåº¦
                progressSpeed: 0.04,        // è¿›åº¦æ¡é€Ÿåº¦
                killToWin: 20,              // éœ€è¦æ¶ˆç­20ä¸ªåƒµå°¸é€šå…³
                // åƒµå°¸è¡€é‡é…ç½®
                zombieHealth: {
                    normal: 15,             // æ™®é€šåƒµå°¸åŸºç¡€è¡€é‡
                    trash: 22.5,            // åƒåœ¾æ¡¶åƒµå°¸ï¼ˆ1.5å€ï¼‰
                    iron: 30                // é“æ¡¶åƒµå°¸ï¼ˆ2å€ï¼‰
                },
                plantHealth: {              // æ¤ç‰©è¡€é‡
                    peashooter: 3,
                    sunflower: 3,
                    wallnut: 15,
                    snowpea: 3,
                    cherrybomb: 1           // æ¨±æ¡ƒç‚¸å¼¹ä¸€æ¬¡æ€§ä½¿ç”¨
                },
                bulletDamage: {             // å­å¼¹ä¼¤å®³
                    peashooter: 1,
                    snowpea: 1
                },
                sunSpawnRate: 7000,         // å…¨å±€é˜³å…‰ç”Ÿæˆé€Ÿåº¦
                // å‘æ—¥è‘µäº§é˜³å…‰å‚æ•°
                sunflower: {
                    initialSunRate: 1000,   // å¼€å±€1ç§’äº§ä¸€æ¬¡é˜³å…‰
                    laterSunRate: 1500,     // ä¹‹å1.5ç§’äº§ä¸€æ¬¡é˜³å…‰
                    switchTime: 20000       // 20ç§’ååˆ‡æ¢ä¸ºæ…¢é€Ÿ
                },
                // æ¨±æ¡ƒç‚¸å¼¹é…ç½®
                cherryBomb: {
                    radius: 3,              // 3x3èŒƒå›´ï¼ˆ9æ ¼ï¼‰
                    adjacentRows: 2,        // é‚»è¿‘2è¡Œ
                    damage: 999             // ç§’æ€ä¼¤å®³
                }
            },
            zombieKilled: 0,
            gameStartTime: 0,
            // è®¡æ—¶å™¨
            timers: {
                spawnZombie: null,
                spawnSun: null,
                gameLoop: null,
                zombieStartTimer: null
            }
        };

        // DOMå…ƒç´ 
        const el = {
            // ç”¨æˆ·åç›¸å…³
            usernameModal: document.getElementById('username-modal'),
            usernameInput: document.getElementById('username-input'),
            confirmUsername: document.getElementById('confirm-username'),
            usernameError: document.getElementById('username-error'),
            playerInfo: document.getElementById('player-info'),
            playerName: document.getElementById('player-name'),
            killCount: document.getElementById('kill-count'),
            killTotal: document.getElementById('kill-total'),
            zombieStats: document.getElementById('zombie-stats'),
            
            // æ¸¸æˆæ ¸å¿ƒ
            sunCount: document.getElementById('sun-count'),
            startGame: document.getElementById('start-game'),
            resetGame: document.getElementById('reset-game'),
            plantCards: document.querySelectorAll('.plant-card'),
            gameGrid: document.getElementById('game-grid'),
            sunLayer: document.getElementById('sun-layer'),
            zombieLayer: document.getElementById('zombie-layer'),
            bulletLayer: document.getElementById('bullet-layer'),
            explosionLayer: document.getElementById('explosion-layer'),
            progressFill: document.getElementById('progress-fill'),
            gameOver: document.getElementById('game-over'),
            gameContainer: document.getElementById('game-container')
        };

        // åˆå§‹åŒ–ç”¨æˆ·ååŠŸèƒ½
        function initUsername() {
            // ç¡®è®¤ç”¨æˆ·å
            el.confirmUsername.addEventListener('click', () => {
                const username = el.usernameInput.value.trim();
                
                if (!username || username.length < 2 || username.length > 10) {
                    el.usernameError.style.display = 'block';
                    return;
                }
                
                // ä¿å­˜ç”¨æˆ·å
                game.username = username;
                
                // æ›´æ–°UI
                el.playerName.textContent = username;
                el.killTotal.textContent = game.gameBalance.killToWin;
                el.usernameModal.style.display = 'none';
                el.playerInfo.style.display = 'block';
                el.zombieStats.style.display = 'block';
                
                // å¯ç”¨æ¸¸æˆæŒ‰é’®
                el.startGame.disabled = false;
                el.resetGame.disabled = false;
                
                showMessage(`æ¬¢è¿ ${username}ï¼å‡†å¤‡å¼€å§‹æ¸¸æˆ`, 'green');
            });
            
            // å›è½¦ç¡®è®¤
            el.usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    el.confirmUsername.click();
                }
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆç½‘æ ¼
        function initGrid() {
            el.gameGrid.innerHTML = '';
            game.grid = [];
            
            // åˆ›å»º5è¡Œ9åˆ—çš„æ ¼å­
            for (let row = 0; row < 5; row++) {
                game.grid[row] = [];
                for (let col = 0; col < 9; col++) {
                    game.grid[row][col] = null;
                    
                    const cell = document.createElement('div');
                    cell.className = 'game-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // ç»‘å®šç§æ¤äº‹ä»¶
                    cell.addEventListener('click', () => {
                        if (game.isRunning && game.selectedPlant) {
                            plantAt(row, col);
                        }
                    });
                    
                    el.gameGrid.appendChild(cell);
                }
            }
            
            // æ›´æ–°é˜³å…‰æ˜¾ç¤º
            el.sunCount.textContent = game.sun;
            el.killCount.textContent = game.zombieKilled;
        }

        // åˆå§‹åŒ–æ¤ç‰©é€‰æ‹©
        function initPlantSelection() {
            el.plantCards.forEach(card => {
                card.addEventListener('click', () => {
                    if (!game.isRunning) {
         
